<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>AI Tr·ª£ Gi√∫p H·ªçc Sinh ‚Äì N√≥i & Nghe</title>
 <style>
  /* Reset + mobile-first layout */
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f7ff;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
  }

  .card {
    background: white;
    width: 100%;
    max-width: 520px;
    margin: 16px;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    text-align: center;
  }

  h2 {
    font-size: 1.4rem;
    margin: 0 0 6px;
  }

  p {
    font-size: 0.95rem;
    color: #4b5563;
    margin-top: 4px;
    margin-bottom: 12px;
  }

  button {
    padding: 12px 20px;
    border-radius: 999px;
    border: none;
    font-size: 1rem;
    margin: 6px;
    cursor: pointer;
  }

  #startBtn {
    background: #2563eb;
    color: #fff;
  }
  #stopBtn {
    background: #ef4444;
    color: #fff;
  }

  #status {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #555;
    min-height: 18px;
  }

  #avatar-wrapper {
    margin-top: 14px;
  }

  /* Avatar scale for mobile */
  #avatar {
    width: 120px;
    height: 120px;
  }

  /* Waveform */
  #waveformCanvas {
    margin-top: 16px;
    border-radius: 12px;
    background: #e5e7eb;
    width: 100%;
    max-width: 320px;
  }

  #transcript,
  #aiText {
    margin-top: 12px;
    padding: 10px 14px;
    border-radius: 8px;
    background: #f9fafb;
    font-size: 0.9rem;
    text-align: left;
    white-space: pre-wrap;
  }

  audio {
    margin-top: 12px;
    width: 100%;
  }

  /* ====== MEDIA QUERIES ====== */

  /* Tablet & desktop: scale up */
  @media (min-width: 600px) {
    h2 {
      font-size: 1.6rem;
    }
    button {
      font-size: 1.1rem;
      padding: 12px 24px;
    }
    #avatar {
      width: 140px;
      height: 140px;
    }
    #waveformCanvas {
      max-width: 360px;
      height: 60px;
    }
  }

  @media (min-width: 900px) {
    .card {
      padding: 28px 36px;
    }
    #avatar {
      width: 160px;
      height: 160px;
    }
    p {
      font-size: 1rem;
    }
  }
</style>

</head>
<body>

<div class="card">
  <h2>üéß AI Tr·ª£ Gi√∫p H·ªçc Sinh</h2>
  <p>B·∫•m <b>Start</b> r·ªìi n√≥i v√†o micro. H·ªá th·ªëng s·∫Ω t·ª± d·ª´ng n·∫øu im l·∫∑ng 3 gi√¢y v√† c√¥ AI s·∫Ω tr·∫£ l·ªùi cho b·∫°n.</p>

  <div>
    <button id="startBtn">üéô Start</button>
    <button id="stopBtn" disabled>‚èπ Stop</button>
  </div>

  <div id="status">Ch∆∞a ghi √¢m.</div>

  <!-- Avatar vui nh·ªôn -->
  <div id="avatar-wrapper">
    <svg id="avatar" width="140" height="140" viewBox="0 0 140 140">
      <!-- M·∫∑t -->
      <circle cx="70" cy="70" r="55" fill="#fee2e2" />

      <!-- M√° h·ªìng -->
      <circle cx="48" cy="82" r="6" fill="#fecaca" />
      <circle cx="92" cy="82" r="6" fill="#fecaca" />

      <!-- M·∫Øt -->
      <ellipse id="leftEye" cx="54" cy="58" rx="5" ry="7" fill="#111827" />
      <ellipse id="rightEye" cx="86" cy="58" rx="5" ry="7" fill="#111827" />

      <!-- L√¥ng m√†y -->
      <line id="leftBrow" x1="44" y1="45" x2="64" y2="43"
            stroke="#111827" stroke-width="3" stroke-linecap="round" />
      <line id="rightBrow" x1="76" y1="43" x2="96" y2="45"
            stroke="#111827" stroke-width="3" stroke-linecap="round" />

      <!-- Mi·ªáng (s·∫Ω animate khi AI n√≥i) -->
      <rect id="mouth"
            x="48"
            y="80"
            width="44"
            height="6"
            rx="3"
            fill="#b91c1c" />
    </svg>
  </div>

  <!-- Waveform khi ƒëang ghi √¢m -->
  <canvas id="waveformCanvas"
          width="280"
          height="60"
          style="margin-top:16px;border-radius:12px;background:#e5e7eb;"></canvas>

  <div id="transcript"><b>H·ªçc sinh n√≥i:</b> (ch∆∞a c√≥)</div>
  <div id="aiText"><b>AI tr·∫£ l·ªùi:</b> (ch∆∞a c√≥)</div>

  <audio id="audioPlayer" controls style="display:none;"></audio>
</div>

<script>
  // === Bi·∫øn ghi √¢m & waveform ===
  let mediaRecorder;
  let audioChunks = [];

  let audioContextRecord;
  let analyserRecord;
  let microphone;
  let waveformAnimationId = null;

  let lastSoundTime = 0;
  const SILENCE_LIMIT = 3000; // 3 gi√¢y im l·∫∑ng th√¨ auto stop

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const statusEl = document.getElementById("status");
  const transcriptEl = document.getElementById("transcript");
  const aiTextEl = document.getElementById("aiText");
  const audioPlayer = document.getElementById("audioPlayer");

  // Canvas waveform
  const waveformCanvas = document.getElementById("waveformCanvas");
  const wctx = waveformCanvas.getContext("2d");

  function clearWaveform() {
    wctx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
    wctx.fillStyle = "#e5e7eb";
    wctx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
  }
  clearWaveform();

  // === Avatar elements ===
  const mouth = document.getElementById("mouth");
  const leftEye = document.getElementById("leftEye");
  const rightEye = document.getElementById("rightEye");
  const leftBrow = document.getElementById("leftBrow");
  const rightBrow = document.getElementById("rightBrow");

  // M·∫∑c ƒë·ªãnh
  const defaultEyeRx = 5;
  const defaultEyeRy = 7;
  const defaultLeftBrow = { y1: 45, y2: 43 };
  const defaultRightBrow = { y1: 43, y2: 45 };

  let thinking = false;
  let blinkIntervalId = null;

  function setAvatarThinking(on) {
    thinking = on;
    if (on) {
      // Nh∆∞·ªõng m√†y l√™n nh·∫π
      leftBrow.setAttribute("y1", (defaultLeftBrow.y1 - 4).toString());
      leftBrow.setAttribute("y2", (defaultLeftBrow.y2 - 4).toString());
      rightBrow.setAttribute("y1", (defaultRightBrow.y1 - 4).toString());
      rightBrow.setAttribute("y2", (defaultRightBrow.y2 - 4).toString());

      // Blink th∆∞·ªùng xuy√™n h∆°n
      if (!blinkIntervalId) {
        blinkIntervalId = setInterval(() => {
          blinkOnce();
        }, 800);
      }
    } else {
      // Reset m√†y & m·∫Øt
      leftBrow.setAttribute("y1", defaultLeftBrow.y1.toString());
      leftBrow.setAttribute("y2", defaultLeftBrow.y2.toString());
      rightBrow.setAttribute("y1", defaultRightBrow.y1.toString());
      rightBrow.setAttribute("y2", defaultRightBrow.y2.toString());

      leftEye.setAttribute("ry", defaultEyeRy.toString());
      rightEye.setAttribute("ry", defaultEyeRy.toString());

      if (blinkIntervalId) {
        clearInterval(blinkIntervalId);
        blinkIntervalId = null;
      }
    }
  }

  function blinkOnce() {
    // Nh·∫Øm m·∫Øt
    leftEye.setAttribute("ry", "1");
    rightEye.setAttribute("ry", "1");
    setTimeout(() => {
      // M·ªü l·∫°i
      leftEye.setAttribute("ry", defaultEyeRy.toString());
      rightEye.setAttribute("ry", defaultEyeRy.toString());
    }, 120);
  }

  // === V·∫Ω waveform khi ƒëang ghi √¢m ===
  function drawWaveform() {
    if (!analyserRecord) return;

    const bufferLength = analyserRecord.fftSize;
    const dataArray = new Uint8Array(bufferLength);
    analyserRecord.getByteTimeDomainData(dataArray);

    // T√≠nh ƒë·ªô "·ªìn" ƒë·ªÉ nh·∫≠n xem c√≥ ti·∫øng n√≥i
    let total = 0;
    for (let i = 0; i < bufferLength; i++) {
      const v = dataArray[i] - 128;
      total += Math.abs(v);
    }
    const avg = total / bufferLength; // 0 ~ im l·∫∑ng
    const volumeNorm = avg / 128;     // 0‚Äì1

    const now = Date.now();
    if (volumeNorm > 0.05) {
      lastSoundTime = now;
      statusEl.textContent = "ƒêang ghi √¢m... con c·ª© n√≥i t·ª± nhi√™n nh√©.";
    } else {
      if (
        mediaRecorder &&
        mediaRecorder.state === "recording" &&
        now - lastSoundTime > SILENCE_LIMIT
      ) {
        statusEl.textContent =
          "Kh√¥ng th·∫•y ti·∫øng trong 3 gi√¢y, h·ªá th·ªëng t·ª± d·ª´ng v√† g·ª≠i c√¢u h·ªèi cho AI.";
        stopRecording(true);
      }
    }

    const width = waveformCanvas.width;
    const height = waveformCanvas.height;

    wctx.clearRect(0, 0, width, height);
    wctx.fillStyle = "#e5e7eb";
    wctx.fillRect(0, 0, width, height);

    // ƒê∆∞·ªùng waveform
    wctx.lineWidth = 2;
    wctx.strokeStyle = "#2563eb";
    wctx.beginPath();

    const sliceWidth = (width * 1.0) / bufferLength;
    let x = 0;

    for (let i = 0; i < bufferLength; i++) {
      const v = dataArray[i] / 255.0;
      const y = v * height;

      if (i === 0) {
        wctx.moveTo(x, y);
      } else {
        wctx.lineTo(x, y);
      }

      x += sliceWidth;
    }
    wctx.stroke();

    // D·∫£i √°nh s√°ng ·ªü gi·ªØa
    wctx.fillStyle = "rgba(37, 99, 235, 0.18)";
    const centerY = height / 2;
    const amp = Math.max(4, volumeNorm * (height / 1.2));
    wctx.fillRect(0, centerY - amp / 2, width, amp);

    waveformAnimationId = requestAnimationFrame(drawWaveform);
  }

  // === B·∫Øt ƒë·∫ßu ghi √¢m ===
  startBtn.onclick = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        sendAudioToServer(audioBlob);

        if (waveformAnimationId) cancelAnimationFrame(waveformAnimationId);
        waveformAnimationId = null;
        clearWaveform();

        if (audioContextRecord) {
          audioContextRecord.close();
          audioContextRecord = null;
        }
      };

      mediaRecorder.start();
      statusEl.textContent = "ƒêang ghi √¢m... con h√£y ƒë·∫∑t c√¢u h·ªèi.";
      startBtn.disabled = true;
      stopBtn.disabled = false;

      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      audioContextRecord = new AudioCtx();
      microphone = audioContextRecord.createMediaStreamSource(stream);
      analyserRecord = audioContextRecord.createAnalyser();
      analyserRecord.fftSize = 512;

      microphone.connect(analyserRecord);
      lastSoundTime = Date.now();

      drawWaveform();
    } catch (err) {
      console.error(err);
      statusEl.textContent =
        "Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c micro. H√£y ki·ªÉm tra quy·ªÅn tr√™n tr√¨nh duy·ªát.";
    }
  };

  // === H√†m d·ª´ng ghi chung ===
  function stopRecording(isAuto = false) {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      stopBtn.disabled = true;
      startBtn.disabled = false;

      if (!isAuto) {
        statusEl.textContent = "ƒêang x·ª≠ l√Ω...";
      }
    }
  }

  stopBtn.onclick = () => {
    stopRecording(false);
  };

  // === Lip sync avatar khi AI n√≥i ===
  let talkAudioCtx = null;
  let talkAnalyser = null;
  let talkSource = null;
  let talkAnimId = null;

  function setupTalkAnalyser() {
    if (talkAudioCtx) return;

    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    talkAudioCtx = new AudioCtx();
    talkSource = talkAudioCtx.createMediaElementSource(audioPlayer);
    talkAnalyser = talkAudioCtx.createAnalyser();
    talkAnalyser.fftSize = 256;

    talkSource.connect(talkAnalyser);
    // Kh√¥ng c·∫ßn connect t·ªõi destination, audioPlayer t·ª± ph√°t
  }

  function animateMouth() {
    if (!talkAnalyser) return;

    const bufferLength = talkAnalyser.fftSize;
    const dataArray = new Uint8Array(bufferLength);
    talkAnalyser.getByteFrequencyData(dataArray);

    let sum = 0;
    for (let i = 0; i < bufferLength; i++) sum += dataArray[i];
    const avg = sum / bufferLength;
    const volume = avg / 255; // 0‚Äì1

    // Mi·ªáng cao t·ªëi ƒëa 22px, t·ªëi thi·ªÉu 4px
    const minH = 4;
    const maxH = 22;
    const h = minH + (maxH - minH) * volume;

    mouth.setAttribute("height", h.toS
