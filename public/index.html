<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>AI Tr·ª£ Gi√∫p H·ªçc Sinh DHE: T∆∞∆°ng t√°c tr·ª±c tuy·∫øn.</title>
  <style>
  /* Reset + mobile-first layout */
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f7ff;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }

  .card {
    background: white;
    margin: 16px;
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    text-align: center;
    min-width: 400px;
  }

  h2 {
    font-size: 1.4rem;
    margin: 0 0 6px;
  }

  p {
    font-size: 0.95rem;
    color: #4b5563;
    margin-top: 4px;
    margin-bottom: 12px;
  }

  button {
    padding: 12px 20px;
    border-radius: 999px;
    border: none;
    font-size: 1rem;
    margin: 6px;
    cursor: pointer;
  }

  #startBtn {
    background: #2563eb;
    color: #fff;
  }
  #stopBtn {
    background: #ef4444;
    color: #fff;
  }

  #status {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #555;
    min-height: 18px;
  }

  #avatar-wrapper {
    margin-top: 14px;
  }

  /* Avatar scale for mobile */
  #avatar {
    width: 120px;
    height: 120px;
  }

  /* Waveform */
  #waveformCanvas {
    margin-top: 16px;
    border-radius: 12px;
    background: #e5e7eb;
    width: 100%;
    max-width: 320px;
  }

  #transcript,
  #aiText {
    margin-top: 12px;
    padding: 10px 14px;
    border-radius: 8px;
    background: #f9fafb;
    font-size: 0.9rem;
    text-align: left;
    white-space: pre-wrap;
  }

  audio {
    margin-top: 12px;
    width: 100%;
  }

  /* ====== MEDIA QUERIES ====== */

  /* Tablet & desktop: scale up */
  @media (min-width: 600px) {
    h2 {
      font-size: 1.6rem;
    }
    button {
      font-size: 1.1rem;
      padding: 12px 24px;
    }
    #avatar {
      width: 140px;
      height: 140px;
    }
    #waveformCanvas {
      max-width: 360px;
      height: 60px;
    }
  }

  @media (min-width: 900px) {
    .card {
      padding: 28px 36px;
    }
    #avatar {
      width: 160px;
      height: 160px;
    }
    p {
      font-size: 1rem;
    }
  }
  </style>
</head>
<body>

<div class="card">
  <h2>üéß H·ªá th·ªëng Tr·ª£ Gi√∫p H·ªçc Sinh</h2>
  <p>ƒê·ªÉ b·∫Øt ƒë·∫ßu, h√£y b·∫•m <b>Start</b> r·ªìi n√≥i v√†o mic.<br>Khi n√≥i xong h√£y b·∫•m <b>Stop</b> (ho·∫∑c ng∆∞ng trong 3 gi√¢y),<br>H·ªá th·ªëng s·∫Ω bi√™n t·∫≠p th√¥ng tin v√† tr·∫£ l·ªùi b·∫±ng gi·ªçng n√≥i.</p>

  <div>
    <button id="startBtn">üéô Start</button>
    <button id="stopBtn" disabled>‚èπ Stop</button>
  </div>

  <div id="status">Ch∆∞a ghi √¢m.</div>

  <div id="transcript"><b>H·ªçc sinh n√≥i:</b> (ch∆∞a c√≥)</div>
  <div id="aiText"><b>AI tr·∫£ l·ªùi:</b> (ch∆∞a c√≥)</div>

  <audio id="audioPlayer" controls style="margin-top: 12px; width: 100%; display:none;"></audio>
</div>

<script>
  let mediaRecorder;
  let audioChunks = [];

  let audioContext;
  let analyser;
  let microphone;
  let animationId = null;

  let lastSoundTime = 0;
  const SILENCE_LIMIT = 3000; // 3 gi√¢y

  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  const statusEl = document.getElementById("status");
  const transcriptEl = document.getElementById("transcript");
  const aiTextEl = document.getElementById("aiText");
  const audioPlayer = document.getElementById("audioPlayer");

  // ====== PIPELINE TR·∫†NG TH√ÅI B1..B6 ======
  const pipelineSteps = [
    "B1: ƒêang t·∫£i d·ªØ li·ªáu l√™n h·ªá th·ªëng...",
    "B2: ƒêang chuy·ªÉn gi·ªçng n√≥i sang vƒÉn b·∫£n (m√¥ h√¨nh ng√¥n ng·ªØ l·ªõn)...",
    "B3: ƒêang truy c·∫≠p v√† ph√¢n t√≠ch big data c·ªßa nh√† tr∆∞·ªùng...",
    "B4: ƒêang chu·∫©n h√≥a v√† bi√™n t·∫≠p c√¢u tr·∫£ l·ªùi...",
    "B5: ƒêang t·∫°o file √¢m thanh tr·∫£ l·ªùi...",
  ];
  let progressTimer = null;
  let progressIndex = 0;

  function startProcessingProgress() {
    // reset
    stopProcessingProgress();
    progressIndex = 0;
    statusEl.textContent = pipelineSteps[0];

    progressTimer = setInterval(() => {
      progressIndex++;
      if (progressIndex < pipelineSteps.length) {
        statusEl.textContent = pipelineSteps[progressIndex];
      } else {
        // ƒë√£ ƒëi h·∫øt c√°c b∆∞·ªõc m√¥ ph·ªèng, gi·ªØ b∆∞·ªõc cu·ªëi
        clearInterval(progressTimer);
        progressTimer = null;
      }
    }, 1200); // 1.2s m·ªói b∆∞·ªõc cho c·∫£m gi√°c "ƒëang ch·∫°y pipeline"
  }

  function stopProcessingProgress() {
    if (progressTimer) {
      clearInterval(progressTimer);
      progressTimer = null;
    }
  }

  // ===== üé® T·∫†O CANVAS S√ìNG √ÇM (WAVEFORM) =====
  const waveformCanvas = document.createElement("canvas");
  waveformCanvas.width = 260;
  waveformCanvas.height = 60;
  waveformCanvas.style.marginTop = "16px";
  waveformCanvas.style.borderRadius = "12px";
  waveformCanvas.style.background = "#e5e7eb";
  document.querySelector(".card").appendChild(waveformCanvas);

  const wctx = waveformCanvas.getContext("2d");

  function clearWaveform() {
    wctx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
    wctx.fillStyle = "#e5e7eb";
    wctx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
  }

  clearWaveform();

  // V·∫Ω s√≥ng √¢m gi·ªëng Siri (ƒë∆°n gi·∫£n ho√°)
  function drawWaveform() {
    if (!analyser) return;

    const bufferLength = analyser.fftSize;
    const dataArray = new Uint8Array(bufferLength);
    analyser.getByteTimeDomainData(dataArray);

    // T√≠nh ƒë·ªô "·ªìn" ƒë·ªÉ nh·∫≠n bi·∫øt c√≥ ti·∫øng n√≥i
    let total = 0;
    for (let i = 0; i < bufferLength; i++) {
      const v = dataArray[i] - 128;
      total += Math.abs(v);
    }
    const avg = total / bufferLength; // ~0 ‚Üí im l·∫∑ng, cao h∆°n ‚Üí c√≥ ti·∫øng
    const volumeNorm = avg / 128;     // 0‚Äì1

    // N·∫øu √¢m l∆∞·ª£ng ƒë·ªß l·ªõn ‚Üí coi nh∆∞ c√≥ ti·∫øng n√≥i
    const now = Date.now();
    if (volumeNorm > 0.05) {
      lastSoundTime = now;
      statusEl.textContent = "ƒêang ghi √¢m... m·ªùi ƒë·∫∑t c√¢u h·ªèi.";
    } else {
      // N·∫øu im l·∫∑ng > 3 gi√¢y ‚Üí auto STOP
      if (
        mediaRecorder &&
        mediaRecorder.state === "recording" &&
        now - lastSoundTime > SILENCE_LIMIT
      ) {
        statusEl.textContent =
          "Kh√¥ng th·∫•y ti·∫øng trong 3 gi√¢y, h·ªá th·ªëng t·ª± d·ª´ng v√† g·ª≠i c√¢u h·ªèi cho AI.";
        stopRecording(true); // true = auto stop
      }
    }

    // V·∫Ω waveform
    const width = waveformCanvas.width;
    const height = waveformCanvas.height;

    wctx.clearRect(0, 0, width, height);
    wctx.fillStyle = "#e5e7eb";
    wctx.fillRect(0, 0, width, height);

    wctx.lineWidth = 2;
    wctx.strokeStyle = "#2563eb";
    wctx.beginPath();

    const sliceWidth = (width * 1.0) / bufferLength;
    let x = 0;

    for (let i = 0; i < bufferLength; i++) {
      const v = dataArray[i] / 255.0; // 0‚Äì1
      const y = v * height;

      if (i === 0) {
        wctx.moveTo(x, y);
      } else {
        wctx.lineTo(x, y);
      }

      x += sliceWidth;
    }

    wctx.stroke();

    // V·∫Ω "d·∫£i" √°nh s√°ng ·ªü gi·ªØa nh∆∞ Siri
    wctx.fillStyle = "rgba(37, 99, 235, 0.15)";
    const centerY = height / 2;
    const amp = Math.max(4, volumeNorm * (height / 2));
    wctx.fillRect(0, centerY - amp / 2, width, amp);

    animationId = requestAnimationFrame(drawWaveform);
  }

  // ===== üéô B·∫ÆT ƒê·∫¶U GHI √ÇM =====
  startBtn.onclick = async () => {
    try {
      // Khi b·∫Øt ƒë·∫ßu ghi √¢m m·ªõi ‚Üí d·ª´ng ph√°t audio c≈© & reset pipeline
      stopProcessingProgress();

      audioPlayer.pause();
      audioPlayer.currentTime = 0;
    } catch (e) {
      console.log("Kh√¥ng th·ªÉ d·ª´ng audio (kh√¥ng sao):", e);
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        // B·∫Øt ƒë·∫ßu m√¥ ph·ªèng pipeline x·ª≠ l√Ω ngay khi stop xong
        startProcessingProgress();
        sendAudioToServer(audioBlob);
        // D·ª´ng waveform
        if (animationId) cancelAnimationFrame(animationId);
        animationId = null;
        clearWaveform();
        // T·∫Øt audioContext cho ƒë·ª° t·ªën t√†i nguy√™n
        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }
      };

      mediaRecorder.start();
      statusEl.textContent = "ƒêang ghi √¢m... m·ªùi ƒë·∫∑t c√¢u h·ªèi.";

      startBtn.disabled = true;
      stopBtn.disabled = false;

      // Thi·∫øt l·∫≠p Web Audio ƒë·ªÉ ƒëo s√≥ng √¢m
      const AudioCtx =
        window.AudioContext || window.webkitAudioContext;
      audioContext = new AudioCtx();
      microphone = audioContext.createMediaStreamSource(stream);
      analyser = audioContext.createAnalyser();
      analyser.fftSize = 512;

      microphone.connect(analyser);

      // Ghi nh·∫≠n th·ªùi ƒëi·ªÉm c√≥ ti·∫øng n√≥i g·∫ßn nh·∫•t
      lastSoundTime = Date.now();

      // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p v·∫Ω waveform
      drawWaveform();
    } catch (err) {
      console.error(err);
      statusEl.textContent =
        "Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c micro. H√£y ki·ªÉm tra quy·ªÅn tr√™n tr√¨nh duy·ªát.";
    }
  };

  // ===== ‚èπ H√ÄM STOP CHUNG (d√πng cho c·∫£ auto stop & click stop) =====
  function stopRecording(isAuto = false) {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      stopBtn.disabled = true;
      startBtn.disabled = false;

      if (!isAuto) {
        statusEl.textContent = "ƒêang k·∫øt th√∫c ghi √¢m, chu·∫©n b·ªã g·ª≠i l√™n h·ªá th·ªëng...";
      }
    }
  }

  // N√∫t Stop do ng∆∞·ªùi d√πng b·∫•m
  stopBtn.onclick = () => {
    stopRecording(false);
  };

  // ===== üì§ G·ª¨I √ÇM THANH L√äN SERVER =====
  async function sendAudioToServer(audioBlob) {
    try {
      const formData = new FormData();
      formData.append("audio", audioBlob, "speech.webm");

      const response = await fetch("/api/voice-chat", {
        method: "POST",
        body: formData,
      });

      if (!response.ok) throw new Error("Server error");

      const data = await response.json();

      // Ngay khi c√≥ k·∫øt qu·∫£ ‚Üí d·ª´ng pipeline m√¥ ph·ªèng
      stopProcessingProgress();

      transcriptEl.innerHTML =
        "<b>H·ªçc sinh n√≥i:</b> " + (data.transcript || "(kh√¥ng nh·∫≠n ƒë∆∞·ª£c)");
      aiTextEl.innerHTML =
        "<b>AI tr·∫£ l·ªùi:</b> " + (data.ai_text || "(kh√¥ng nh·∫≠n ƒë∆∞·ª£c)");

      if (data.audio_url) {
        audioPlayer.src = data.audio_url;
        audioPlayer.style.display = "block";

        // B5 ƒë√£ xong, chu·∫©n b·ªã ph√°t
        statusEl.textContent =
          "B5: ƒê√£ t·∫°o xong file √¢m thanh. B6: ƒêang ph√°t file √¢m thanh...";

        audioPlayer.play();

        audioPlayer.onplay = () => {
          statusEl.textContent = "B6: ƒêang ph√°t file √¢m thanh tr·∫£ l·ªùi...";
        };

        audioPlayer.onended = () => {
          statusEl.textContent =
            "Ho√†n th√†nh: ƒê√£ ph√°t xong. B·∫°n c√≥ th·ªÉ b·∫•m Start ƒë·ªÉ h·ªèi ti·∫øp.";
        };
      } else {
        audioPlayer.style.display = "none";
        statusEl.textContent =
          "ƒê√£ x·ª≠ l√Ω xong (ch∆∞a t·∫°o ƒë∆∞·ª£c √¢m thanh, vui l√≤ng ƒë·ªçc c√¢u tr·∫£ l·ªùi tr√™n m√†n h√¨nh).";
      }
    } catch (err) {
      console.error(err);
      stopProcessingProgress();
      statusEl.textContent = "C√≥ l·ªói khi g·ª≠i √¢m thanh l√™n server.";
    }
  }
</script>

</body>
</html>
