<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>AI Tr·ª£ Gi√∫p H·ªçc Sinh DHE: T∆∞∆°ng t√°c n√≥i - nghe</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: #f4f7ff;
    }
    .card {
      background: white;
      padding: 24px 32px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      max-width: 480px;
      width: 100%;
      text-align: center;
    }
    button {
      padding: 12px 24px;
      border-radius: 999px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      margin: 8px;
    }
    #startBtn {
      background: #2563eb;
      color: #fff;
    }
    #stopBtn {
      background: #ef4444;
      color: #fff;
    }
    #status {
      margin-top: 12px;
      font-size: 14px;
      color: #555;
    }
    #transcript, #aiText {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      background: #f9fafb;
      font-size: 14px;
      text-align: left;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<div class="card">
  <h2>üéß AI Tr·ª£ Gi√∫p H·ªçc Sinh</h2>
  <p>B·∫•m <b>Start</b> r·ªìi n√≥i v√†o mic. AI s·∫Ω nghe v√† tr·∫£ l·ªùi b·∫±ng gi·ªçng n√≥i.</p>

  <div>
    <button id="startBtn">üéô Start</button>
    <button id="stopBtn" disabled>‚èπ Stop</button>
  </div>

  <div id="status">Ch∆∞a ghi √¢m.</div>

  <div id="transcript"><b>H·ªçc sinh n√≥i:</b> (ch∆∞a c√≥)</div>
  <div id="aiText"><b>AI tr·∫£ l·ªùi:</b> (ch∆∞a c√≥)</div>

  <audio id="audioPlayer" controls style="margin-top: 12px; width: 100%; display:none;"></audio>
</div>

<script>
  let mediaRecorder;
  let audioChunks = [];

  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const statusEl = document.getElementById('status');
  const transcriptEl = document.getElementById('transcript');
  const aiTextEl = document.getElementById('aiText');
  const audioPlayer = document.getElementById('audioPlayer');

  // B·∫•m Start: xin quy·ªÅn micro + b·∫Øt ƒë·∫ßu ghi
  startBtn.onclick = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      audioChunks = [];
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        sendAudioToServer(audioBlob);
      };

      mediaRecorder.start();
      statusEl.textContent = 'ƒêang ghi √¢m... H√£y n√≥i v√†o micro.';
      startBtn.disabled = true;
      stopBtn.disabled = false;
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c micro. H√£y ki·ªÉm tra quy·ªÅn tr√¨nh duy·ªát.';
    }
  };

  // B·∫•m Stop: d·ª´ng ghi, g·ª≠i audio l√™n server
  stopBtn.onclick = () => {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
      statusEl.textContent = 'ƒêang x·ª≠ l√Ω...';
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  };

  // G·ª≠i audio l√™n server /api/voice-chat
  async function sendAudioToServer(audioBlob) {
    try {
      const formData = new FormData();
      formData.append('audio', audioBlob, 'speech.webm');

      const response = await fetch('/api/voice-chat', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) throw new Error('Server error');

      const data = await response.json();

      transcriptEl.innerHTML =
        '<b>H·ªçc sinh n√≥i:</b> ' + (data.transcript || '(kh√¥ng nh·∫≠n ƒë∆∞·ª£c)');
      aiTextEl.innerHTML =
        '<b>AI tr·∫£ l·ªùi:</b> ' + (data.ai_text || '(kh√¥ng nh·∫≠n ƒë∆∞·ª£c)');

      if (data.audio_url) {
        audioPlayer.src = data.audio_url;
        audioPlayer.style.display = 'block';
        audioPlayer.play();
      } else {
        audioPlayer.style.display = 'none';
      }

      statusEl.textContent = 'ƒê√£ x·ª≠ l√Ω xong.';
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'C√≥ l·ªói khi g·ª≠i √¢m thanh l√™n server.';
    }
  }
</script>

</body>
</html>
